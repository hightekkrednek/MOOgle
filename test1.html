<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Farm Animal Tracker</title>

<!-- ======================== -->
<!-- CSS Section -->
<!-- ======================== -->
<style>
  body {
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    margin: 20px;
    background-color: #f9fafb;
    color: #2c3e50;
  }

  h1, h2, h3 { color: #1f618d; }
  h1 { margin-bottom: 5px; }
  h2 { margin-top: 25px; margin-bottom: 10px; }
  h3 { margin-top: 20px; }

  p { margin: 0 0 10px 0; font-style: italic; color: #34495e; }

  button {
    margin: 2px;
    padding: 6px 12px;
    background-color: #3498db;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
  }
  button:hover { background-color: #2980b9; }

  input, select {
    padding: 5px 8px;
    margin: 2px 0;
    border: 1px solid #ccc;
    border-radius: 4px;
    width: auto;
  }

  form {
    background-color: #ffffff;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 3px 6px rgba(0,0,0,0.1);
    margin-bottom: 20px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    margin-bottom: 15px;
    background-color: #ffffff;
    border-radius: 6px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }
  th, td {
    border-bottom: 1px solid #ddd;
    padding: 8px;
    text-align: left;
  }
  th { background-color: #ecf0f1; font-weight: bold; }

  .overdue { background-color: #f8d7da !important; }
  .administered { background-color: #d6dbdf !important; }

  #ageDisplay { font-weight: bold; margin-left: 10px; }

  .form-row { display: flex; flex-wrap: wrap; margin-bottom: 8px; }
  .form-row > div { flex: 1; min-width: 150px; margin-right: 10px; }
  .form-row > div:last-child { margin-right: 0; }
</style>
</head>
<body>

<h1 id="farmName">My Farm</h1>
<p id="farmContact">Address / Phone</p>
<button onclick="editFarmInfo()">Edit Farm Info</button>

<h2>Overdue Medications</h2>
<table id="overdueMedsTable"></table>
<button onclick="loadOverdueMeds()">Refresh Overdue List</button>

<h2>Search Animal</h2>
<div class="form-row">
  <div>Tag #: <input id="searchTag" maxlength="4" placeholder="Tag #"><button onclick="searchByTag()">Search</button></div>
  <div>Tattoo #: <input id="searchTattoo" maxlength="4" placeholder="Tattoo #"><button onclick="searchByTattoo()">Search</button></div>
</div>

<h2>Add / Edit Animal</h2>
<button type="button" onclick="newRecord()">New Record</button><br><br>

<form id="animalForm" onsubmit="saveAnimal(); return false;">

  <div class="form-row">
    <div>Tag #: <input id="tag" maxlength="4" required></div>
    <div>Tattoo #: <input id="tattoo" maxlength="4"></div>
  </div>

  <div class="form-row">
    <div>Breed:
      <select id="animalBreed"></select>
      <button type="button" onclick="editDropdown('breedOptions','animalBreed')">Edit Breeds</button>
    </div>
    <div>Type:
      <select id="animalType">
        <option>Cow</option>
        <option>Bull</option>
      </select>
    </div>
    <div>Location: <input id="animalLocation"></div>
  </div>

  <div class="form-row">
    <div>Maternal: <input id="maternalName"></div>
    <div>Paternal: <input id="paternalName"></div>
  </div>

  <div class="form-row">
    <div>Udder Suspension:
      <select id="udderSuspension"></select>
      <button type="button" onclick="editDropdown('udderSuspensionOptions','udderSuspension')">Edit</button>
    </div>
    <div>Udder Size:
      <select id="udderSize"></select>
      <button type="button" onclick="editDropdown('udderSizeOptions','udderSize')">Edit</button>
    </div>
  </div>

  <div class="form-row">
    <div>Calving Ease:
      <select id="calvingEase"></select>
      <button type="button" onclick="editDropdown('calvingEaseOptions','calvingEase')">Edit</button>
    </div>
    <div>Docility:
      <select id="docility"></select>
      <button type="button" onclick="editDropdown('docilityOptions','docility')">Edit</button>
    </div>
  </div>

  <div class="form-row">
    <div>Date of Birth: <input type="date" id="dob" onchange="updateAge()"><span id="ageDisplay"></span></div>
    <div>Date of Death: <input type="date" id="dod"></div>
  </div>

  <h3>Medications</h3>
  <div class="form-row">
    <div>Date: <input type="date" id="medDate"></div>
    <div>Type: <input id="medType"></div>
    <div>Quantity: <input id="medQuantity"></div>
    <div>Next Due: <input type="date" id="medNextDue"></div>
    <div><button type="button" onclick="addMedication()">Add Medication</button></div>
  </div>
  <table id="medicationsTable"></table>

  <button type="submit">Save Animal</button>
</form>

<h2>Animals List</h2>
<table id="animalsTable"></table>

<h2>Import / Export</h2>
<input type="file" id="importFile">
<button onclick="importData()">Import</button>
<button onclick="exportData()">Export</button>

<script>
// --------------------
// Global Variables
// --------------------
let animals = [];
let breedOptions = ["Gelbvieh","Balancer"];
let udderSuspensionOptions = [1,2,3,4,5,6,7,8,9];
let udderSizeOptions = [1,2,3,4,5,6,7,8,9];
let calvingEaseOptions = [1,2,3,4,5];
let docilityOptions = [1,2,3,4,5];
let currentAnimalIndex = null;

// --------------------
// Initialization
// --------------------
window.onload = function() {
  loadFarmInfo();
  populateDropdown('animalBreed', breedOptions);
  populateDropdown('udderSuspension', udderSuspensionOptions);
  populateDropdown('udderSize', udderSizeOptions);
  populateDropdown('calvingEase', calvingEaseOptions);
  populateDropdown('docility', docilityOptions);
  loadAnimalsTable();
  loadOverdueMeds();
};

// --------------------
// Dropdown Utilities
// --------------------
function populateDropdown(id, options){
  const select = document.getElementById(id);
  select.innerHTML="";
  options.forEach(opt=>{
    let o=document.createElement("option");
    o.value=opt; o.text=opt;
    select.add(o);
  });
}
function editDropdown(optionArrayName, selectId){
  let newVal = prompt("Enter comma-separated values:");
  if(!newVal) return;
  window[optionArrayName] = newVal.split(",").map(s=>s.trim());
  populateDropdown(selectId, window[optionArrayName]);
}

// --------------------
// Farm Info
// --------------------
function loadFarmInfo(){
  document.getElementById('farmName').innerText = localStorage.getItem('farmName')||"My Farm";
  document.getElementById('farmContact').innerText = localStorage.getItem('farmContact')||"Address / Phone";
}
function editFarmInfo(){
  let name = prompt("Farm Name:", document.getElementById('farmName').innerText);
  let contact = prompt("Address / Phone:", document.getElementById('farmContact').innerText);
  if(name) localStorage.setItem('farmName', name);
  if(contact) localStorage.setItem('farmContact', contact);
  loadFarmInfo();
}

// --------------------
// Animal CRUD
// --------------------
function newRecord(){
  currentAnimalIndex = null;
  document.getElementById('animalForm').reset();
  document.getElementById('ageDisplay').innerText="";
  document.getElementById('medicationsTable').innerHTML="";
  localStorage.setItem('tempMedList', JSON.stringify([]));
}
function saveAnimal(){
  let animal = {
    tag: document.getElementById('tag').value,
    tattoo: document.getElementById('tattoo').value,
    breed: document.getElementById('animalBreed').value,
    type: document.getElementById('animalType').value,
    location: document.getElementById('animalLocation').value,
    maternal: document.getElementById('maternalName').value,
    paternal: document.getElementById('paternalName').value,
    udderSuspension: document.getElementById('udderSuspension').value,
    udderSize: document.getElementById('udderSize').value,
    calvingEase: document.getElementById('calvingEase').value,
    docility: document.getElementById('docility').value,
    dob: document.getElementById('dob').value,
    dod: document.getElementById('dod').value,
    medications: JSON.parse(localStorage.getItem('tempMedList')||"[]")
  };
  if(currentAnimalIndex===null){
    animals.push(animal);
  } else {
    animals[currentAnimalIndex] = animal;
  }
  localStorage.setItem('animals', JSON.stringify(animals));
  loadAnimalsTable();
  loadOverdueMeds();
  newRecord();
}

// --------------------
// Load Animals Table
// --------------------
function loadAnimalsTable(){
  animals = JSON.parse(localStorage.getItem('animals')||"[]");
  let table = document.getElementById('animalsTable');
  table.innerHTML="";
  if(animals.length===0) return;
  let headers = Object.keys(animals[0]).filter(k=>k!=='medications');
  let tr = table.insertRow();
  headers.forEach(h=>tr.insertCell().innerHTML=h);
  tr.insertCell().innerHTML="Edit/Delete";
  animals.forEach((a,i)=>{
    let r = table.insertRow();
    headers.forEach(h=> r.insertCell().innerText = a[h] || "");
    let cell=r.insertCell();
    cell.innerHTML=`<button onclick="editAnimal(${i})">Edit</button>
                    <button onclick="deleteAnimal(${i})">Delete</button>`;
  });
}

// --------------------
// Edit/Delete Animal
// --------------------
function editAnimal(i){
  currentAnimalIndex=i;
  let a=animals[i];
  document.getElementById('tag').value=a.tag;
  document.getElementById('tattoo').value=a.tattoo;
  document.getElementById('animalBreed').value=a.breed;
  document.getElementById('animalType').value=a.type;
  document.getElementById('animalLocation').value=a.location;
  document.getElementById('maternalName').value=a.maternal;
  document.getElementById('paternalName').value=a.paternal;
  document.getElementById('udderSuspension').value=a.udderSuspension;
  document.getElementById('udderSize').value=a.udderSize;
  document.getElementById('calvingEase').value=a.calvingEase;
  document.getElementById('docility').value=a.docility;
  document.getElementById('dob').value=a.dob;
  document.getElementById('dod').value=a.dod;
  localStorage.setItem('tempMedList', JSON.stringify(a.medications||[]));
  loadMedicationsTable();
  updateAge();
}
function deleteAnimal(i){
  if(confirm("Delete this animal?")){
    animals.splice(i,1);
    localStorage.setItem('animals', JSON.stringify(animals));
    loadAnimalsTable();
    loadOverdueMeds();
    newRecord();
  }
}

// --------------------
// Medications
// --------------------
function addMedication(){
  let med={
    date: document.getElementById('medDate').value || "",
    type: document.getElementById('medType').value || "",
    quantity: document.getElementById('medQuantity').value || "",
    nextDue: document.getElementById('medNextDue').value || "",
    administered: false
  };
  let meds=JSON.parse(localStorage.getItem('tempMedList')||"[]");
  meds.push(med);
  localStorage.setItem('tempMedList', JSON.stringify(meds));
  loadMedicationsTable();
  loadOverdueMeds();
}

function loadMedicationsTable(){
  let meds = JSON.parse(localStorage.getItem('tempMedList')||"[]");
  let table = document.getElementById('medicationsTable');
  table.innerHTML = "";
  let now = new Date(); now.setHours(0,0,0,0);

  meds.forEach((m,i)=>{
    let r = table.insertRow();
    r.insertCell().innerText = m.date || "";
    r.insertCell().innerText = m.type || "";
    r.insertCell().innerText = m.quantity || "";
    r.insertCell().innerText = m.nextDue || "";

    if(m.nextDue && !m.administered){
      let parts = m.nextDue.split('-');
      let due = new Date(parts[0], parts[1]-1, parts[2]);
      if(due <= now){ r.classList.add('overdue'); }
    }

    if(m.administered) r.classList.add('administered');

    let c=r.insertCell();
    let checkboxHTML="";
    if(m.nextDue){
      let checkedAttr = m.administered ? "checked" : "";
      checkboxHTML = `<label><input type="checkbox" ${checkedAttr} onchange="toggleAdministered(${i}, this)"> Administered</label>`;
    }
    c.innerHTML=`<button onclick="editMedication(${i})">Edit</button>
                 <button onclick="deleteMedication(${i})">Delete</button>
                 ${checkboxHTML}`;
  });
}

function toggleAdministered(index, checkbox){
  let meds = JSON.parse(localStorage.getItem('tempMedList')||"[]");
  meds[index].administered = checkbox.checked;
  localStorage.setItem('tempMedList', JSON.stringify(meds));
  loadMedicationsTable();
  loadOverdueMeds();
}

function editMedication(i){
  let meds=JSON.parse(localStorage.getItem('tempMedList')||"[]");
  let m=meds[i];
  document.getElementById('medDate').value=m.date || "";
  document.getElementById('medType').value=m.type || "";
  document.getElementById('medQuantity').value=m.quantity || "";
  document.getElementById('medNextDue').value=m.nextDue || "";
  meds.splice(i,1);
  localStorage.setItem('tempMedList', JSON.stringify(meds));
  loadMedicationsTable();
  loadOverdueMeds();
}

function deleteMedication(i){
  let meds=JSON.parse(localStorage.getItem('tempMedList')||"[]");
  meds.splice(i,1);
  localStorage.setItem('tempMedList', JSON.stringify(meds));
  loadMedicationsTable();
  loadOverdueMeds();
}

// --------------------
// Overdue Medications
// --------------------
function loadOverdueMeds(){
  let now = new Date(); now.setHours(0,0,0,0);
  let table = document.getElementById('overdueMedsTable');
  table.innerHTML = "";

  animals.forEach(a => {
    (a.medications || []).forEach(m => {
      if(m.nextDue && !m.administered){
        let parts = m.nextDue.split('-');
        let due = new Date(parts[0], parts[1]-1, parts[2]);
        if(due <= now){
          let r = table.insertRow();
          r.insertCell().innerText = a.tag || "";
          r.insertCell().innerText = m.type || "";
          r.insertCell().innerText = m.nextDue || "";
          r.style.backgroundColor = "#f8d7da";
        }
      }
    });
  });
}

// --------------------
// Age calculation
// --------------------
function updateAge(){
  let dob=document.getElementById('dob').value;
  if(!dob) { document.getElementById('ageDisplay').innerText=""; return; }
  let birth=new Date(dob);
  let now=new Date();
  let years=now.getFullYear()-birth.getFullYear();
  let months=now.getMonth()-birth.getMonth();
  let days=now.getDate()-birth.getDate();
  if(days<0){ months--; days+=new Date(now.getFullYear(), now.getMonth(),0).getDate(); }
  if(months<0){ years--; months+=12; }
  document.getElementById('ageDisplay').innerText=`${years}y ${months}m ${days}d`;
}

// --------------------
// Search Functions
// --------------------
function searchByTag(){
  let tag = document.getElementById('searchTag').value;
  let i = animals.findIndex(a => a.tag === tag);
  if(i >= 0) editAnimal(i);
  else alert("No animal found with that Tag #");
}

function searchByTattoo(){
  let tat = document.getElementById('searchTattoo').value;
  let i = animals.findIndex(a => a.tattoo === tat);
  if(i >= 0) editAnimal(i);
  else alert("No animal found with that Tattoo #");
}

// --------------------
// Import / Export Functions
// --------------------
function exportData(){
  let data = {
    farmName: document.getElementById('farmName').innerText,
    farmContact: document.getElementById('farmContact').innerText,
    animals: animals
  };
  let dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data, null, 2));
  let a = document.createElement('a');
  a.href = dataStr;
  a.download = "FarmAnimalData.json";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

function importData(){
  let fileInput = document.getElementById('importFile');
  if(!fileInput.files.length) { alert("Select a file first"); return; }
  let file = fileInput.files[0];
  let reader = new FileReader();
  reader.onload = function(e){
    try {
      let imported = JSON.parse(e.target.result);
      if(imported.farmName) document.getElementById('farmName').innerText = imported.farmName;
      if(imported.farmContact) document.getElementById('farmContact').innerText = imported.farmContact;

      imported.animals.forEach(newAnimal => {
        let index = animals.findIndex(a => a.tag === newAnimal.tag && a.tattoo === newAnimal.tattoo);
        if(index < 0){
          animals.push(newAnimal); // silently add if not exist
        } else {
          // compare fields for differences
          let existing = animals[index];
          let differences = [];
          for(let key in newAnimal){
            if(JSON.stringify(newAnimal[key]) !== JSON.stringify(existing[key])){
              differences.push(key);
            }
          }
          if(differences.length){
            let msg = `Differences found for Tag ${existing.tag}, Tattoo ${existing.tattoo}:\n${differences.join(", ")}\nAccept changes?`;
            if(confirm(msg)) animals[index] = newAnimal;
          }
        }
      });
      localStorage.setItem('animals', JSON.stringify(animals));
      loadAnimalsTable();
      loadOverdueMeds();
    } catch(err){
      alert("Invalid file format.");
    }
  };
  reader.readAsText(file);
}
</script>

</body>
</html>