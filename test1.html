<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Farm Animal Tracker</title>
<style>
body{font-family:"Segoe UI",Tahoma,Verdana,sans-serif;background:#f4f6f8;color:#2c3e50;margin:20px;}
h1,h2,h3{color:#1f618d;margin-top:20px;}
button{padding:6px 12px;margin:3px;background:#3498db;color:#fff;border:none;border-radius:4px;cursor:pointer;}
button:hover{background:#2980b9;}
input,select{padding:5px 8px;margin:2px 0;border:1px solid #ccc;border-radius:4px;width:100%;}
table{width:100%;border-collapse:collapse;margin-top:10px;margin-bottom:15px;background:#fff;border-radius:6px;overflow:hidden;}
th,td{border-bottom:1px solid #ddd;padding:8px;text-align:left;}
th{background:#ecf0f1;font-weight:bold;}
tr.overdue{background:#f8d7da;}
tr.administered{background:#d6dbdf;}
.form-section{background:#fff;padding:15px 20px;margin-bottom:20px;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,0.1);}
.form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:15px;}
.form-row{display:flex;flex-direction:column;margin-bottom:5px;}
label{font-weight:bold;margin-bottom:4px;}
#ageDisplay{font-weight:bold;margin-left:10px;}
.flex-row{display:flex;align-items:center;gap:10px;}
</style>
</head>
<body>

<div class="form-section">
<h1 id="farmName">My Farm</h1>
<p id="farmContact">Address / Phone</p>
<button onclick="editFarmInfo()">Edit Farm Info</button>
</div>

<div class="form-section">
<h2>Overdue Medications</h2>
<table id="overdueMedsTable"></table>
<button onclick="loadOverdueMeds()">Refresh Overdue List</button>
</div>

<div class="form-section flex-row">
<div>Tag #: <input id="searchTag" maxlength="4"><button onclick="searchByTag()">Search</button></div>
<div>Tattoo #: <input id="searchTattoo" maxlength="4"><button onclick="searchByTattoo()">Search</button></div>
</div>

<div class="form-section">
<h2>Add / Edit Animal</h2>
<button type="button" onclick="newRecord()">New Record</button>
<form id="animalForm" onsubmit="saveAnimal();return false;">
<div class="form-grid">
<div class="form-row"><label>Tag # (required)</label><input id="tag" maxlength="4" required></div>
<div class="form-row"><label>Tattoo #</label><input id="tattoo" maxlength="4"></div>
<div class="form-row"><label>Breed</label><select id="animalBreed"></select><button type="button" onclick="editDropdown('breedOptions','animalBreed')">Edit</button></div>
<div class="form-row"><label>Type</label><select id="animalType"><option>Cow</option><option>Bull</option></select></div>
<div class="form-row"><label>Location / Property</label><input id="animalLocation"></div>
<div class="form-row"><label>Maternal Parent</label><input id="maternalName"></div>
<div class="form-row"><label>Paternal Parent</label><input id="paternalName"></div>
<div class="form-row"><label>Udder Suspension</label><select id="udderSuspension"></select><button type="button" onclick="editDropdown('udderSuspensionOptions','udderSuspension')">Edit</button></div>
<div class="form-row"><label>Udder Size</label><select id="udderSize"></select><button type="button" onclick="editDropdown('udderSizeOptions','udderSize')">Edit</button></div>
<div class="form-row"><label>Calving Ease</label><select id="calvingEase"></select><button type="button" onclick="editDropdown('calvingEaseOptions','calvingEase')">Edit</button></div>
<div class="form-row"><label>Docility</label><select id="docility"></select><button type="button" onclick="editDropdown('docilityOptions','docility')">Edit</button></div>
<div class="form-row flex-row"><label>Date of Birth</label><input type="date" id="dob" onchange="updateAge()"><span id="ageDisplay"></span></div>
<div class="form-row"><label>Date of Death</label><input type="date" id="dod"></div>
</div>

<h3>Medications</h3>
<div class="form-grid">
<div class="form-row"><label>Date Administered</label><input type="date" id="medDate"></div>
<div class="form-row"><label>Medication Type</label><input id="medType"></div>
<div class="form-row"><label>Quantity</label><input id="medQuantity"></div>
<div class="form-row"><label>Next Due</label><input type="date" id="medNextDue"></div>
<div class="form-row"><button type="button" onclick="addMedication()">Add Medication</button></div>
</div>
<table id="medicationsTable"></table>
<div><button type="submit">Save Animal</button></div>
</form>
</div>

<div class="form-section">
<h2>Animals List</h2>
<table id="animalsTable"></table>
</div>

<div class="form-section">
<h2>Import / Export</h2>
<input type="file" id="importFile">
<button onclick="importData()">Import</button>
<button onclick="exportData()">Export</button>
</div>

<script>
// -----------------------------
// Globals
// -----------------------------
let animals=[], breedOptions=["Gelbvieh","Balancer"];
let udderSuspensionOptions=[1,2,3,4,5,6,7,8,9], udderSizeOptions=[1,2,3,4,5,6,7,8,9];
let calvingEaseOptions=[1,2,3,4,5], docilityOptions=[1,2,3,4,5];
let currentAnimalIndex=null;
localStorage.setItem('tempMedList', JSON.stringify([]));

// -----------------------------
// Initialization
// -----------------------------
window.onload=function(){
  loadFarmInfo();
  populateDropdown('animalBreed',breedOptions);
  populateDropdown('udderSuspension',udderSuspensionOptions);
  populateDropdown('udderSize',udderSizeOptions);
  populateDropdown('calvingEase',calvingEaseOptions);
  populateDropdown('docility',docilityOptions);
  animals=JSON.parse(localStorage.getItem('animals')||"[]");
  loadAnimalsTable();
  loadOverdueMeds();
  renderMedications();
};

// -----------------------------
// Dropdown Helpers
// -----------------------------
function populateDropdown(id,options){
  const select=document.getElementById(id);
  select.innerHTML="";
  options.forEach(opt=>{ let o=document.createElement("option"); o.value=opt; o.text=opt; select.add(o); });
}
function editDropdown(optionArrayName, selectId){
  let newVal=prompt("Enter comma-separated values:");
  if(!newVal) return;
  window[optionArrayName]=newVal.split(",").map(s=>s.trim());
  populateDropdown(selectId, window[optionArrayName]);
}

// -----------------------------
// Farm Info
// -----------------------------
function loadFarmInfo(){
  document.getElementById('farmName').innerText=localStorage.getItem('farmName')||"My Farm";
  document.getElementById('farmContact').innerText=localStorage.getItem('farmContact')||"Address / Phone";
}
function editFarmInfo(){
  let name=prompt("Farm Name:", document.getElementById('farmName').innerText);
  let contact=prompt("Address / Phone:", document.getElementById('farmContact').innerText);
  if(name) localStorage.setItem('farmName',name);
  if(contact) localStorage.setItem('farmContact',contact);
  loadFarmInfo();
}

// -----------------------------
// Age Calculation
// -----------------------------
function updateAge(){
  const dob=document.getElementById('dob').value;
  if(!dob){ document.getElementById('ageDisplay').innerText=""; return; }
  const birth=new Date(dob); const today=new Date();
  let y=today.getFullYear()-birth.getFullYear();
  let m=today.getMonth()-birth.getMonth(); let d=today.getDate()-birth.getDate();
  if(d<0){ m--; d+= new Date(today.getFullYear(),today.getMonth(),0).getDate(); }
  if(m<0){ y--; m+=12; }
  document.getElementById('ageDisplay').innerText=`${y}y ${m}m ${d}d`;
}

// -----------------------------
// New Record
// -----------------------------
function newRecord(){
  currentAnimalIndex=null;
  document.getElementById('animalForm').reset();
  document.getElementById('ageDisplay').innerText="";
  localStorage.setItem('tempMedList',JSON.stringify([]));
  renderMedications();
}

// -----------------------------
// Medications
// -----------------------------
function renderMedications(){
  const meds=JSON.parse(localStorage.getItem('tempMedList')||"[]");
  const table=document.getElementById('medicationsTable');
  table.innerHTML="<tr><th>Date Administered</th><th>Type</th><th>Quantity</th><th>Next Due</th><th>Administered</th><th>Actions</th></tr>";
  meds.forEach((m,i)=>{
    const row=table.insertRow();
    row.insertCell(0).innerText=m.dateAdministered;
    row.insertCell(1).innerText=m.type;
    row.insertCell(2).innerText=m.quantity;
    row.insertCell(3).innerText=m.nextDue;
    const chkCell=row.insertCell(4);
    const chk=document.createElement('input'); chk.type='checkbox'; chk.checked=m.administered||false;
    chk.onchange=function(){ m.administered=chk.checked; localStorage.setItem('tempMedList',JSON.stringify(meds)); renderMedications(); loadOverdueMeds(); };
    chkCell.appendChild(chk);
    const actCell=row.insertCell(5);
    const editBtn=document.createElement('button'); editBtn.innerText='Edit'; editBtn.onclick=()=>editMedication(i);
    const delBtn=document.createElement('button'); delBtn.innerText='Delete'; delBtn.onclick=()=>deleteMedication(i);
    actCell.appendChild(editBtn); actCell.appendChild(delBtn);
    if(m.nextDue && !m.administered && new Date(m.nextDue) <= new Date()){ row.classList.add('overdue'); }
    if(m.administered) row.classList.add('administered');
  });
}

function addMedication(){
  const meds=JSON.parse(localStorage.getItem('tempMedList')||"[]");
  meds.push({dateAdministered:document.getElementById('medDate').value,type:document.getElementById('medType').value,quantity:document.getElementById('medQuantity').value,nextDue:document.getElementById('medNextDue').value,administered:false});
  localStorage.setItem('tempMedList',JSON.stringify(meds));
  renderMedications();
}

// -----------------------------
// Save / Load Animals
// -----------------------------
function saveAnimal(){
  const tempMeds=JSON.parse(localStorage.getItem('tempMedList')||"[]");
  const animal={tag:document.getElementById('tag').value,tattoo:document.getElementById('tattoo').value,breed:document.getElementById('animalBreed').value,type:document.getElementById('animalType').value,location:document.getElementById('animalLocation').value,maternal:document.getElementById('maternalName').value,paternal:document.getElementById('paternalName').value,udderSuspension:document.getElementById('udderSuspension').value,udderSize:document.getElementById('udderSize').value,calvingEase:document.getElementById('calvingEase').value,docility:document.getElementById('docility').value,dob:document.getElementById('dob').value,dod:document.getElementById('dod').value,medications:tempMeds};
  if(currentAnimalIndex===null){ animals.push(animal); }else{ animals[currentAnimalIndex]=animal; }
  localStorage.setItem('animals',JSON.stringify(animals));
  loadAnimalsTable();
  newRecord();
  loadOverdueMeds();
}

// -----------------------------
// Load Animal Table
// -----------------------------
function loadAnimalsTable(){
  const table=document.getElementById('animalsTable');
  table.innerHTML="<tr><th>Tag</th><th>Tattoo</th><th>Breed</th><th>Type</th><th>Location</th><th>DOB</th><th>DOD</th><th>Actions</th></tr>";
  animals.forEach((a,i)=>{
    const row=table.insertRow();
    row.insertCell(0).innerText=a.tag;
    row.insertCell(1).innerText=a.tattoo;
    row.insertCell(2).innerText=a.breed;
    row.insertCell(3).innerText=a.type;
    row.insertCell(4).innerText=a.location;
    row.insertCell(5).innerText=a.dob;
    row.insertCell(6).innerText=a.dod;
    const cell=row.insertCell(7);
    const editBtn=document.createElement('button'); editBtn.innerText='Edit'; editBtn.onclick=()=>editAnimal(i);
    const delBtn=document.createElement('button'); delBtn.innerText='Delete'; delBtn.onclick=()=>deleteAnimal(i);
    cell.appendChild(editBtn); cell.appendChild(delBtn);
  });
}

// -----------------------------
// Edit / Delete Animal
// -----------------------------
function editAnimal(idx){
  currentAnimalIndex=idx;
  const a=animals[idx];
  document.getElementById('tag').value=a.tag;
  document.getElementById('tattoo').value=a.tattoo;
  document.getElementById('animalBreed').value=a.breed;
  document.getElementById('animalType').value=a.type;
  document.getElementById('animalLocation').value=a.location;
  document.getElementById('maternalName').value=a.maternal;
  document.getElementById('paternalName').value=a.paternal;
  document.getElementById('udderSuspension').value=a.udderSuspension;
  document.getElementById('udderSize').value=a.udderSize;
  document.getElementById('calvingEase').value=a.calvingEase;
  document.getElementById('docility').value=a.docility;
  document.getElementById('dob').value=a.dob; updateAge();
  document.getElementById('dod').value=a.dod;
  localStorage.setItem('tempMedList',JSON.stringify(a.medications));
  renderMedications();
}

function deleteAnimal(idx){
  if(confirm("Delete this animal?")){ animals.splice(idx,1); localStorage.setItem('animals',JSON.stringify(animals)); loadAnimalsTable(); loadOverdueMeds(); }
}

// -----------------------------
// Search
// -----------------------------
function searchByTag(){ const t=document.getElementById('searchTag').value; const idx=animals.findIndex(a=>a.tag===t); if(idx>=0) editAnimal(idx); else alert("Not found"); }
function searchByTattoo(){ const t=document.getElementById('searchTattoo').value; const idx=animals.findIndex(a=>a.tattoo===t); if(idx>=0) editAnimal(idx); else alert("Not found"); }

// -----------------------------
// Edit/Delete Medication
// -----------------------------
function editMedication(idx){
  const meds=JSON.parse(localStorage.getItem('tempMedList')||"[]");
  const m=meds[idx];
  document.getElementById('medDate').value=m.dateAdministered;
  document.getElementById('medType').value=m.type;
  document.getElementById('medQuantity').value=m.quantity;
  document.getElementById('medNextDue').value=m.nextDue;
  meds.splice(idx,1);
  localStorage.setItem('tempMedList',JSON.stringify(meds));
  renderMedications();
}
function deleteMedication(idx){
  const meds=JSON.parse(localStorage.getItem('tempMedList')||"[]");
  meds.splice(idx,1);
  localStorage.setItem('tempMedList',JSON.stringify(meds));
  renderMedications();
}

// -----------------------------
// Overdue Medications
// -----------------------------
function loadOverdueMeds(){
  const table=document.getElementById('overdueMedsTable');
  table.innerHTML="<tr><th>Animal</th><th>Tag</th><th>Medication</th><th>Next Due</th></tr>";
  animals.forEach(a=>{
    a.medications.forEach(m=>{
      if(m.nextDue && !m.administered && new Date(m.nextDue) <= new Date()){
        const row=table.insertRow();
        row.insertCell(0).innerText=a.breed+" "+a.type;
        row.insertCell(1).innerText=a.tag;
        row.insertCell(2).innerText=m.type;
        row.insertCell(3).innerText=m.nextDue;
        row.classList.add('overdue');
      }
    });
  });
}

// -----------------------------
// Import / Export
// -----------------------------
function exportData(){
  const data=JSON.stringify({animals:animals,farmName:localStorage.getItem('farmName'),farmContact:localStorage.getItem('farmContact')});
  const blob=new Blob([data],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='farm_data.json'; a.click();
}

function importData(){
  const file=document.getElementById('importFile').files[0];
  if(!file){ alert("Select a file"); return; }
  const reader=new FileReader();
  reader.onload=function(e){
    const imported=JSON.parse(e.target.result);
    if(imported.farmName) localStorage.setItem('farmName',imported.farmName);
    if(imported.farmContact) localStorage.setItem('farmContact',imported.farmContact);
    if(imported.animals){
      imported.animals.forEach(imp=>{
        const idx        =animals.findIndex(a => a.tag === imp.tag && a.tattoo === imp.tattoo);
        if(idx === -1){
          // New record, just add
          animals.push(imp);
        } else {
          // Existing record differs, ask for confirmation
          const existing=animals[idx];
          let diffFields = [];
          for(const key in imp){
            if(JSON.stringify(imp[key]) !== JSON.stringify(existing[key])) diffFields.push(key);
          }
          if(diffFields.length){
            let msg = `Animal Tag: ${imp.tag}, Tattoo: ${imp.tattoo} has differences in: ${diffFields.join(", ")}.\nAccept changes?`;
            if(confirm(msg)){
              animals[idx] = imp;
            }
          }
        }
      });
    }
    localStorage.setItem('animals', JSON.stringify(animals));
    loadFarmInfo();
    loadAnimalsTable();
    loadOverdueMeds();
  };
  reader.readAsText(file);
}
</script>
</body>
</html>