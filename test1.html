<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Farm Animal Tracker</title>

<!-- ========================
     CSS Section
======================== -->
<style>
body {
  font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  margin: 20px;
  background-color: #f9fafb;
  color: #2c3e50;
}

h1,h2,h3 { color: #1f618d; }
h1 { margin-bottom: 5px; }
h2 { margin-top: 25px; margin-bottom: 10px; }
h3 { margin-top: 20px; }

button {
  margin: 2px;
  padding: 6px 12px;
  background-color: #3498db;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-weight: bold;
}
button:hover { background-color: #2980b9; }

input, select {
  padding: 5px 8px;
  margin: 2px 0;
  border: 1px solid #ccc;
  border-radius: 4px;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
  margin-bottom: 15px;
  background-color: #ffffff;
  border-radius: 6px;
  overflow: hidden;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
th, td {
  border-bottom: 1px solid #ddd;
  padding: 8px;
  text-align: left;
}
th { background-color: #ecf0f1; font-weight: bold; }

.overdue { background-color: #f8d7da !important; }
.administered { background-color: #d6dbdf !important; }

/* ========================
   Add/Edit Animal Form Layout
======================== */
#animalForm {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 15px;
  background-color: #ffffff;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 3px 6px rgba(0,0,0,0.1);
}
#animalForm .form-row { display: flex; flex-direction: column; }
#animalForm label { font-weight: bold; margin-bottom: 4px; }
#animalForm input, #animalForm select { width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; }
#animalForm button { margin-top: 8px; }

#ageDisplay { font-weight: bold; margin-left: 10px; }
</style>
</head>
<body>

<!-- ========================
     Farm Info Section
======================== -->
<h1 id="farmName">My Farm</h1>
<p id="farmContact">Address / Phone</p>
<button onclick="editFarmInfo()">Edit Farm Info</button>

<!-- ========================
     Overdue Medications Table
======================== -->
<h2>Overdue Medications</h2>
<table id="overdueMedsTable"></table>
<button onclick="loadOverdueMeds()">Refresh Overdue List</button>

<!-- ========================
     Search Animal Section
======================== -->
<h2>Search Animal</h2>
<div style="display:flex; gap:20px; margin-bottom:15px;">
  <div>Tag #: <input id="searchTag" maxlength="4" placeholder="Tag #"><button onclick="searchByTag()">Search</button></div>
  <div>Tattoo #: <input id="searchTattoo" maxlength="4" placeholder="Tattoo #"><button onclick="searchByTattoo()">Search</button></div>
</div>

<!-- ========================
     Add / Edit Animal Form
======================== -->
<h2>Add / Edit Animal</h2>
<button type="button" onclick="newRecord()">New Record</button><br><br>

<form id="animalForm" onsubmit="saveAnimal(); return false;">
  <!-- Animal ID -->
  <div class="form-row">
    <label for="tag">Tag # (required)</label>
    <input id="tag" maxlength="4" required>
  </div>
  <div class="form-row">
    <label for="tattoo">Tattoo #</label>
    <input id="tattoo" maxlength="4">
  </div>

  <!-- Breed & Type -->
  <div class="form-row">
    <label for="animalBreed">Breed</label>
    <select id="animalBreed"></select>
    <button type="button" onclick="editDropdown('breedOptions','animalBreed')">Edit Breeds</button>
  </div>
  <div class="form-row">
    <label for="animalType">Type</label>
    <select id="animalType"><option>Cow</option><option>Bull</option></select>
  </div>

  <!-- Location & Parents -->
  <div class="form-row"><label for="animalLocation">Location / Property</label><input id="animalLocation"></div>
  <div class="form-row"><label for="maternalName">Maternal Parent</label><input id="maternalName"></div>
  <div class="form-row"><label for="paternalName">Paternal Parent</label><input id="paternalName"></div>

  <!-- Scoring Dropdowns -->
  <div class="form-row"><label for="udderSuspension">Udder Suspension</label><select id="udderSuspension"></select><button type="button" onclick="editDropdown('udderSuspensionOptions','udderSuspension')">Edit</button></div>
  <div class="form-row"><label for="udderSize">Udder Size</label><select id="udderSize"></select><button type="button" onclick="editDropdown('udderSizeOptions','udderSize')">Edit</button></div>
  <div class="form-row"><label for="calvingEase">Calving Ease</label><select id="calvingEase"></select><button type="button" onclick="editDropdown('calvingEaseOptions','calvingEase')">Edit</button></div>
  <div class="form-row"><label for="docility">Docility (Temperament)</label><select id="docility"></select><button type="button" onclick="editDropdown('docilityOptions','docility')">Edit</button></div>

  <!-- DOB / DOD -->
  <div class="form-row"><label for="dob">Date of Birth</label><input type="date" id="dob" onchange="updateAge()"><span id="ageDisplay"></span></div>
  <div class="form-row"><label for="dod">Date of Death</label><input type="date" id="dod"></div>

  <!-- Medications Section -->
  <h3>Medications</h3>
  <div class="form-row"><label for="medDate">Date Administered</label><input type="date" id="medDate"></div>
  <div class="form-row"><label for="medType">Medication Type</label><input id="medType"></div>
  <div class="form-row"><label for="medQuantity">Quantity</label><input id="medQuantity"></div>
  <div class="form-row"><label for="medNextDue">Next Due</label><input type="date" id="medNextDue"></div>
  <div class="form-row"><button type="button" onclick="addMedication()">Add Medication</button></div>
  <table id="medicationsTable"></table>

  <!-- Save Button -->
  <div class="form-row"><button type="submit">Save Animal</button></div>
</form>

<!-- Animals List -->
<h2>Animals List</h2>
<table id="animalsTable"></table>

<!-- Import/Export -->
<h2>Import / Export</h2>
<input type="file" id="importFile">
<button onclick="importData()">Import</button>
<button onclick="exportData()">Export</button>

<!-- ========================
     JavaScript Section
======================== -->
<script>
// -----------------------
// Data & Global Variables
// -----------------------
let animals=[], breedOptions=["Gelbvieh","Balancer"];
let udderSuspensionOptions=[1,2,3,4,5,6,7,8,9], udderSizeOptions=[1,2,3,4,5,6,7,8,9];
let calvingEaseOptions=[1,2,3,4,5], docilityOptions=[1,2,3,4,5];
let currentAnimalIndex=null;

// -----------------------
// Page Initialization
// -----------------------
window.onload=function(){
  loadFarmInfo();
  populateDropdown('animalBreed', breedOptions);
  populateDropdown('udderSuspension', udderSuspensionOptions);
  populateDropdown('udderSize', udderSizeOptions);
  populateDropdown('calvingEase', calvingEaseOptions);
  populateDropdown('docility', docilityOptions);
  animals = JSON.parse(localStorage.getItem('animals')||"[]");
  loadAnimalsTable();
  loadOverdueMeds();
  localStorage.setItem('tempMedList', JSON.stringify([]));
};

// -----------------------
// Dropdown Helpers
// -----------------------
function populateDropdown(id,options){
  const select=document.getElementById(id);
  select.innerHTML="";
  options.forEach(opt=>{ let o=document.createElement("option"); o.value=opt; o.text=opt; select.add(o); });
}
function editDropdown(optionArrayName, selectId){
  let newVal=prompt("Enter comma-separated values:");
  if(!newVal) return;
  window[optionArrayName]=newVal.split(",").map(s=>s.trim());
  populateDropdown(selectId, window[optionArrayName]);
}

// -----------------------
// Farm Info
// -----------------------
function loadFarmInfo(){
  document.getElementById('farmName').innerText=localStorage.getItem('farmName')||"My Farm";
  document.getElementById('farmContact').innerText=localStorage.getItem('farmContact')||"Address / Phone";
}
function editFarmInfo(){
  let name=prompt("Farm Name:", document.getElementById('farmName').innerText);
  let contact=prompt("Address / Phone:", document.getElementById('farmContact').innerText);
  if(name) localStorage.setItem('farmName',name);
  if(contact) localStorage.setItem('farmContact',contact);
  loadFarmInfo();
}

// -----------------------
// Add/Edit Animal
// -----------------------
function newRecord(){
  currentAnimalIndex=null;
  document.getElementById('animalForm').reset();
  document.getElementById('ageDisplay').innerText="";
  localStorage.setItem('tempMedList', JSON.stringify([]));
  renderMedications();
}

function saveAnimal(){
  let animal={
    tag: document.getElementById('tag').value,
    tattoo: document.getElementById('tattoo').value,
    breed: document.getElementById('animalBreed').value,
    type: document.getElementById('animalType').value,
    location: document.getElementById('animalLocation').value,
    maternal: document.getElementById('maternalName').value,
    paternal: document.getElementById('paternalName').value,
    udderSuspension: document.getElementById('udderSuspension').value,
    udderSize: document.getElementById('udderSize').value,
    calvingEase: document.getElementById('calvingEase').value,
    docility: document.getElementById('docility').value,
    dob: document.getElementById('dob').value,
    dod: document.getElementById('dod').value,
    medications: JSON.parse(localStorage.getItem('tempMedList')||"[]")
  };
  if(currentAnimalIndex===null) animals.push(animal);
  else animals[currentAnimalIndex]=animal;
  localStorage.setItem('animals',JSON.stringify(animals));
  loadAnimalsTable();
  loadOverdueMeds();
  newRecord();
}

// -----------------------
// Medications
// -----------------------
function addMedication(){
  let meds=JSON.parse(localStorage.getItem('tempMedList')||"[]");
  meds.push({date:document.getElementById('medDate').value,type:document.getElementById('medType').value,quantity:document.getElementById('medQuantity').value,nextDue:document.getElementById('medNextDue').value,administered:false});
  localStorage.setItem('tempMedList',JSON.stringify(meds));
  renderMedications();
}

function renderMedications(){
  let meds=JSON.parse(localStorage.getItem('tempMedList')||"[]");
  let table=document.getElementById('medicationsTable');
  table.innerHTML="<tr><th>Date</th><th>Type</th><th>Qty</th><th>Next Due</th><th>Administered</th><th>Actions</th></tr>";
  meds.forEach((m,i)=>{
    let row=table.insertRow();
    if(m.administered) row.className="administered";
    else if(m.nextDue && new Date(m.nextDue)<=new Date()) row.className="overdue";
    row.insertCell(0).innerText=m.date;
    row.insertCell(1).innerText=m.type;
    row.insertCell(2).innerText=m.quantity;
    row.insertCell(3).innerText=m.nextDue;
    let chk=row.insertCell(4).appendChild(document.createElement("input"));
    chk.type="checkbox"; chk.checked=m.administered;
    chk.onchange=function(){ m.administered=this.checked; localStorage.setItem('tempMedList',JSON.stringify(meds)); renderMedications(); };
    row.insertCell(5).innerHTML=`<button onclick="editMedication(${i})">Edit</button><button onclick="deleteMedication(${i})">Delete</button>`;
  });
}

function editMedication(i){
  let meds=JSON.parse(localStorage.getItem('tempMedList'));
  let m=meds[i];
  document.getElementById('medDate').value=m.date;
  document.getElementById('medType').value=m.type;
  document.getElementById('medQuantity').value=m.quantity;
  document.getElementById('medNextDue').value=m.nextDue;
  meds.splice(i,1);
  localStorage.setItem('tempMedList',JSON.stringify(meds));
  renderMedications();
}
function deleteMedication(i){
  let meds=JSON.parse(localStorage.getItem('tempMedList'));
  meds.splice(i,1);
  localStorage.setItem('tempMedList',JSON.stringify(meds));
  renderMedications();
}

// -----------------------
// Animals Table
// -----------------------
function loadAnimalsTable(){
  let table=document.getElementById('animalsTable');
  table.innerHTML="<tr><th>Tag</th><th>Tattoo</th><th>Breed</th><th>Type</th><th>Location</th><th>Actions</th></tr>";
  animals.forEach((a,i)=>{
    let row=table.insertRow();
    row.insertCell(0).innerText=a.tag;
    row.insertCell(1).innerText=a.tattoo;
    row.insertCell(2).innerText=a.breed;
    row.insertCell(3).innerText=a.type;
    row.insertCell(4).innerText=a.location;
    row.insertCell(5).innerHTML=`<button onclick="editAnimal(${i})">Edit</button><button onclick="deleteAnimal(${i})">Delete</button>`;
  });
}
function editAnimal(i){
  currentAnimalIndex=i;
  let a=animals[i];
  document.getElementById('tag').value=a.tag;
  document.getElementById('tattoo').value=a.tattoo;
  document.getElementById('animalBreed').value=a.breed;
  document.getElementById('animalType').value=a.type;
  document.getElementById('animalLocation').value=a.location;
  document.getElementById('maternalName').value=a.maternal;
  document.getElementById('paternalName').value=a.paternal;
  document.getElementById('udderSuspension').value=a.udderSuspension;
  document.getElementById('udderSize').value=a.udderSize;
  document.getElementById('calvingEase').value=a.calvingEase;
  document.getElementById('docility').value=a.docility;
  document.getElementById('dob').value=a.dob;
  updateAge();
  document.getElementById('dod').value=a.dod;
  localStorage.setItem('tempMedList',JSON.stringify(a.medications||[]));
  renderMedications();
}
function deleteAnimal(i){
  if(confirm("Delete this animal?")){
    animals.splice(i,1);
    localStorage.setItem('animals',JSON.stringify(animals));
    loadAnimalsTable();
    loadOverdueMeds();
  }
}

// -----------------------
// Search Functions
// -----------------------
function searchByTag(){
  let tag=document.getElementById('searchTag').value;
  let i=animals.findIndex(a=>a.tag===tag);
  if(i>=0) editAnimal(i);
  else alert("No animal found with that Tag #");
}
function searchByTattoo(){
  let tat=document.getElementById('searchTattoo').value;
  let i=animals.findIndex(a=>a.tattoo===tat);
  if(i>=0) editAnimal(i);
  else alert("No animal found with that Tattoo #");
}

// -----------------------
// Age Calculation
// -----------------------
function updateAge(){
  let dob=document.getElementById('dob').value;
  if(!dob) {document.getElementById('ageDisplay').innerText=""; return;}
  let diff=new Date()-new Date(dob);
  let d=new Date(diff);
  let y=d.getUTCFullYear()-1970;
  let m=d.getUTCMonth();
  let day=d.getUTCDate()-1;
  document.getElementById('ageDisplay').innerText=`Age: ${y}y ${m}m ${day}d`;
}

// -----------------------
// Overdue Medications
// -----------------------
function loadOverdueMeds(){
  let table=document.getElementById('overdueMedsTable');
  table.innerHTML="<tr><th>Animal</th><th>Medication</th><th>Next Due</th></tr>";
  animals.forEach(a=>{
    (a.medications||[]).forEach(m=>{
      if(m.nextDue && !m.administered && new Date(m.nextDue)<=new Date()){
        let row=table.insertRow();
        row.insertCell(0).innerText=a.tag;
                row.insertCell(1).innerText = m.type;
        row.insertCell(2).innerText = m.nextDue;
        row.className = "overdue";
      }
    });
  });
}

// -----------------------
// Import / Export Functions
// -----------------------
function exportData() {
  const data = {
    farmName: localStorage.getItem('farmName'),
    farmContact: localStorage.getItem('farmContact'),
    animals: animals
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = "farm_data.json";
  a.click();
  URL.revokeObjectURL(url);
}

function importData() {
  const file = document.getElementById('importFile').files[0];
  if(!file) { alert("Select a file to import."); return; }
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const imported = JSON.parse(e.target.result);

      // Update farm info
      if(imported.farmName) localStorage.setItem('farmName', imported.farmName);
      if(imported.farmContact) localStorage.setItem('farmContact', imported.farmContact);
      loadFarmInfo();

      let newRecords = 0, skipped = 0;

      imported.animals.forEach(impAnimal => {
        let idx = animals.findIndex(a => a.tag === impAnimal.tag);
        if(idx >= 0) {
          // Compare fields for differences
          let local = animals[idx];
          let differences = [];
          for(let key in impAnimal) {
            if(JSON.stringify(impAnimal[key]) !== JSON.stringify(local[key])) differences.push(key);
          }
          if(differences.length > 0) {
            let msg = `Animal Tag: ${impAnimal.tag} has differences in: ${differences.join(", ")}. Accept changes?`;
            if(confirm(msg)) { animals[idx] = impAnimal; newRecords++; } else { skipped++; }
          } else { skipped++; } // identical
        } else {
          animals.push(impAnimal);
          newRecords++;
        }
      });

      localStorage.setItem('animals', JSON.stringify(animals));
      loadAnimalsTable();
      loadOverdueMeds();
      alert(`Import complete. Added/Updated: ${newRecords}, Skipped: ${skipped}`);
    } catch(err) {
      alert("Error reading file: " + err);
    }
  };
  reader.readAsText(file);
}
</script>

</body>
</html>