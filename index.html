<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Farm Animal Tracker</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  table, th, td { border: 1px solid #ccc; border-collapse: collapse; padding: 5px; }
  th { background-color: #eee; }
  button { margin: 2px; }
  .overdue { background-color: #f99 !important; }
</style>
</head>
<body>

<h1 id="farmName">My Farm</h1>
<p id="farmContact">Address / Phone</p>
<button onclick="editFarmInfo()">Edit Farm Info</button>

<h2>3 Add / Edit Animal</h2>
<form id="animalForm" onsubmit="saveAnimal(); return false;">
  Tag #: <input id="tag" maxlength="4" required>
  Tattoo #: <input id="tattoo" maxlength="4"><br><br>

  Breed:
  <select id="animalBreed"></select>
  <button type="button" onclick="editDropdown('breedOptions','animalBreed')">Edit Breeds</button><br><br>

  Type:
  <select id="animalType">
    <option>Cow</option>
    <option>Bull</option>
  </select><br><br>

  Location: <input id="animalLocation"><br><br>
  Maternal: <input id="maternalName">
  Paternal: <input id="paternalName"><br><br>

  Udder Suspension:
  <select id="udderSuspension"></select>
  <button type="button" onclick="editDropdown('udderSuspensionOptions','udderSuspension')">Edit</button><br><br>

  Udder Size:
  <select id="udderSize"></select>
  <button type="button" onclick="editDropdown('udderSizeOptions','udderSize')">Edit</button><br><br>

  Calving Ease:
  <select id="calvingEase"></select>
  <button type="button" onclick="editDropdown('calvingEaseOptions','calvingEase')">Edit</button><br><br>

  Docility:
  <select id="docility"></select>
  <button type="button" onclick="editDropdown('docilityOptions','docility')">Edit</button><br><br>

  <h3>Medications</h3>
  Date: <input type="date" id="medDate">
  Type: <input id="medType">
  Quantity: <input id="medQuantity">
  Next Due: <input type="date" id="medNextDue">
  <button type="button" onclick="addMedication()">Add Medication</button>

  <table id="medicationsTable"></table>

  <br><br>
  <button type="submit">Save Animal</button>
</form>

<h2>Animals List</h2>
<table id="animalsTable"></table>

<h2>Import / Export</h2>
<input type="file" id="importFile">
<button onclick="importData()">Import</button>
<button onclick="exportData()">Export</button>

<script>
let editIndex = null;
let medEditIndex = null;

// Initialization on page load
window.onload = function() {
    // Initialize dropdowns with defaults if empty
    const dropdownDefaults = {
        breedOptions: ['Gelbvieh','Balancer'],
        udderSuspensionOptions: ['1','2','3','4','5','6','7','8','9'],
        udderSizeOptions: ['1','2','3','4','5','6','7','8','9'],
        calvingEaseOptions: ['1','2','3','4','5'],
        docilityOptions: ['1','2','3','4','5']
    };
    for(const key in dropdownDefaults){
        if(!localStorage.getItem(key)){
            localStorage.setItem(key, JSON.stringify(dropdownDefaults[key]));
        }
        populateDropdown(key, key.replace('Options',''));
    }

    // Initialize farm info if empty
    if(!localStorage.getItem('farmName')) localStorage.setItem('farmName','My Farm');
    if(!localStorage.getItem('farmContact')) localStorage.setItem('farmContact','Address / Phone');
    document.getElementById('farmName').textContent = localStorage.getItem('farmName');
    document.getElementById('farmContact').textContent = localStorage.getItem('farmContact');

    // Initialize animals list if empty
    if(!localStorage.getItem('animals')) localStorage.setItem('animals','[]');

    // Load animals table
    loadAnimals();

    // If animals exist, populate the first animal
    const animals = getAnimals();
    if(animals.length > 0){
        editAnimal(0);
    }
};

// Dropdown functions
function populateDropdown(key, selectId){
    const select = document.getElementById(selectId);
    select.innerHTML = '';
    const options = JSON.parse(localStorage.getItem(key) || '[]');
    options.forEach(opt=>{
        const o = document.createElement('option');
        o.value = o.textContent = opt;
        select.appendChild(o);
    });
}

function editDropdown(key, selectId){
    const current = JSON.parse(localStorage.getItem(key) || '[]');
    const newValues = prompt("Edit options (comma-separated):", current.join(","));
    if(newValues !== null){
        const arr = newValues.split(",").map(s=>s.trim()).filter(s=>s);
        localStorage.setItem(key, JSON.stringify(arr));
        populateDropdown(key, selectId);
    }
}

// Farm info
function editFarmInfo(){
  const name = prompt("Farm Name:", document.getElementById('farmName').textContent);
  const contact = prompt("Address / Phone:", document.getElementById('farmContact').textContent);
  if(name){
    document.getElementById('farmName').textContent = name;
    localStorage.setItem('farmName', name);
  }
  if(contact){
    document.getElementById('farmContact').textContent = contact;
    localStorage.setItem('farmContact', contact);
  }
}

// Animals
function getAnimals(){ return JSON.parse(localStorage.getItem('animals') || '[]'); }

function loadAnimals(){
    const animals = getAnimals();
    const table = document.getElementById('animalsTable');
    table.innerHTML = `
      <tr>
        <th>Tag</th>
        <th>Tattoo</th>
        <th>Breed</th>
        <th>Type</th>
        <th>Location</th>
        <th>Actions</th>
      </tr>`;
    animals.forEach((a,i)=>{
        const row = table.insertRow();
        row.insertCell(0).innerText = a.tag;
        row.insertCell(1).innerText = a.tattoo;
        row.insertCell(2).innerText = a.breed;
        row.insertCell(3).innerText = a.type;
        row.insertCell(4).innerText = a.location;
        const actions = row.insertCell(5);
        actions.innerHTML = `<button onclick="editAnimal(${i})">Edit</button>
                             <button onclick="deleteAnimal(${i})">Delete</button>`;
    });
}

function editAnimal(index){
    const animals = getAnimals();
    const a = animals[index];
    editIndex = index;
    document.getElementById('tag').value = a.tag;
    document.getElementById('tattoo').value = a.tattoo;
    document.getElementById('animalBreed').value = a.breed;
    document.getElementById('animalType').value = a.type;
    document.getElementById('animalLocation').value = a.location;
    document.getElementById('maternalName').value = a.maternal;
    document.getElementById('paternalName').value = a.paternal;
    document.getElementById('udderSuspension').value = a.udderSuspension;
    document.getElementById('udderSize').value = a.udderSize;
    document.getElementById('calvingEase').value = a.calvingEase;
    document.getElementById('docility').value = a.docility;
    loadMedicationTable(a.medications || []);
}

function deleteAnimal(index){
    if(confirm("Delete this animal?")){
        const animals = getAnimals();
        animals.splice(index,1);
        localStorage.setItem('animals', JSON.stringify(animals));
        loadAnimals();
        if(editIndex===index){
            editIndex = medEditIndex = null;
            document.getElementById('animalForm').reset();
            document.getElementById('medicationsTable').innerHTML='';
        }
    }
}

// Medications
function loadMedicationTable(meds){
    const table = document.getElementById('medicationsTable');
    table.innerHTML = `
      <tr>
        <th>Date</th><th>Type</th><th>Qty</th><th>Next Due</th><th>Actions</th>
      </tr>`;
    meds.forEach((m,i)=>{
        const row = table.insertRow();
        row.insertCell(0).innerText = m.date;
        row.insertCell(1).innerText = m.type;
        row.insertCell(2).innerText = m.quantity;
        row.insertCell(3).innerText = m.nextDue;
        if(m.nextDue && m.nextDue < new Date().toISOString().split('T')[0]){
            row.classList.add('overdue');
        }
        row.insertCell(4).innerHTML = `<button type="button" onclick="editMedication(${i})">Edit</button>
                                        <button type="button" onclick="deleteMedication(${i})">Delete</button>`;
    });
}

function addMedication(){
    if(editIndex===null){ alert("Save animal first."); return; }
    const animals = getAnimals();
    if(!animals[editIndex].medications) animals[editIndex].medications=[];
    const med = {
        date: document.getElementById('medDate').value,
        type: document.getElementById('medType').value,
        quantity: document.getElementById('medQuantity').value,
        nextDue: document.getElementById('medNextDue').value
    };
    if(medEditIndex!==null){
        animals[editIndex].medications[medEditIndex] = med;
        medEditIndex=null;
    } else {
        animals[editIndex].medications.push(med);
    }
    localStorage.setItem('animals', JSON.stringify(animals));
    loadMedicationTable(animals[editIndex].medications);
    document.getElementById('medDate').value='';
    document.getElementById('medType').value='';
    document.getElementById('medQuantity').value='';
    document.getElementById('medNextDue').value='';
}

function editMedication(i){
    if(editIndex===null) return;
    const animals = getAnimals();
    const m = animals[editIndex].medications[i];
    document.getElementById('medDate').value = m.date;
    document.getElementById('medType').value = m.type;
    document.getElementById('medQuantity').value = m.quantity;
    document.getElementById('medNextDue').value = m.nextDue;
    medEditIndex = i;
}

function deleteMedication(i){
    if(confirm("Delete this medication?")){
        const animals = getAnimals();
        animals[editIndex].medications.splice(i,1);
        localStorage.setItem('animals', JSON.stringify(animals));
        loadMedicationTable(animals[editIndex].medications);
    }
}

// Save animal
function saveAnimal(){
    const animals = getAnimals();
    const animal = {
        tag: document.getElementById('tag').value.trim(),
        tattoo: document.getElementById('tattoo').value.trim(),
        breed: document.getElementById('animalBreed').value,
        type: document.getElementById('animalType').value,
        location: document.getElementById('animalLocation').value,
        maternal: document.getElementById('maternalName').value,
        paternal: document.getElementById('paternalName').value,
        udderSuspension: document.getElementById('udderSuspension').value,
        udderSize: document.getElementById('udderSize').value,
        calvingEase: document.getElementById('calvingEase').value,
        docility: document.getElementById('docility').value,
        medications: editIndex!==null ? animals[editIndex].medications : []
    };
    if(editIndex!==null){
        animals[editIndex] = animal;
        editIndex=null;
    } else {
        animals.push(animal);
    }
    localStorage.setItem('animals', JSON.stringify(animals));
    loadAnimals();
    document.getElementById('animalForm').reset();
    document.getElementById('medicationsTable').innerHTML='';
}

// Import/Export
function exportData(){
    const blob = new Blob([localStorage.getItem('animals') || '[]'], {type:'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='animals.json'; a.click();
}

function importData(){
    const file = document.getElementById('importFile').files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = e=>{
        const imported = JSON.parse(e.target.result);
        const animals = getAnimals();
        imported.forEach(newA=>{
            const idx = animals.findIndex(a=>a.tag===newA.tag && a.tattoo===newA.tattoo);
            if(idx>=0){
                if(confirm(`Update existing animal ${newA.tag}?`)) animals[idx]=newA;
            } else animals.push(newA);
        });
        localStorage.setItem('animals', JSON.stringify(animals));
        loadAnimals();
    };
    reader.readAsText(file);
}
</script>
</body>
</html>